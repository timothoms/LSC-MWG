---
title: "Mapping trajectories"
params: 
  cache: false
  optimize: false
---

```{r setup, include = FALSE}
source("setup.R")
```

<!-- ### {.tabset .tabset-fade .tabset-pills} -->

```{r data, rows.print = 15, cols.print = 12, cols.min.print = 12}
IsTrue <- function(x) { !is.na(x) & x }
load("_data/LSCMWG_working_class.RData")
```

<!-- #### Classifications -->
```{r class, results = 'hide', fig.width = 5, fig.height = 5, out.width = "25%", out.height = "25%", fig.show = "hold", eval = FALSE, echo = FALSE}
df <- unique(df[, c("country", "period", "health_class", "gender_class", "class", "class_vv")])
df$period <- str_sub(df$period, 7, 10)
df <- df[!is.na(df$class) & df$period != 2020, ]
# table(df$class_vv)
# noquote(tapply(X = df$class_vv, INDEX = list(health = df$health_class, gender = df$gender_class), function(set) { paste(unique(set), collapse = "; ") }))
df_new <- pivot_wider(df[, c("country", "period", "class_vv")], names_from = period, values_from = class_vv)
df_new[, -1] <- lapply(df_new[, -1], function(col) {
  col[is.na(col)] <- ""
  return(col)
})
as.data.frame(df_new)
df_new <- pivot_wider(df[, c("country", "period", "class")], names_from = period, values_from = class)
df_new[, -1] <- lapply(df_new[, -1], function(col) {
  col[is.na(col)] <- ""
  return(col)
})
df <- df %>% arrange(country, period)
df <- df %>% group_by(country) %>% 
  mutate(lag_health_class = lag(health_class), lag_gender_class = lag(gender_class), lag_class = lag(class))
df <- df[!is.na(df$lag_class), ]
df <- df[IsTrue(df$lag_class != df$class), ]
list(as.data.frame(df_new[df_new$country %in% df_new$country[!df_new$country %in% unique(df$country)], ]))
lapply(unique(df$country), function(ctry) {
  ggplot(df[df$country == ctry, ], 
         aes(x = lag_gender_class, y = lag_health_class, xend = gender_class, yend = health_class)) + 
    geom_segment(arrow = arrow(angle = 15, type = "closed")) + 
    geom_point(aes(x = lag_gender_class[period == min(period)], 
                   y = lag_health_class[period == min(period)]), 
               shape = 22, size = 3, fill = "red") + 
    geom_point(aes(x = gender_class[period == max(period)], 
                   y = health_class[period == max(period)]), 
               shape = 23, size = 3, fill = "green") + 
    xlim(0.5, 5.5) + ylim(0.5, 5.5) + labs(x = "Gender", y = "Health") + theme_classic() + ggtitle(ctry)
})
```

```{r sequencing, results = 'hide', fig.width = 5, fig.height = 5, out.width = "25%", out.height = "25%", fig.show = "hold", warning = FALSE}
# vars <- names(df)
# vars <- vars[!str_detect(vars, "perf_")]
# lapply(c(variables$health, variables$gender), function(x) {
#   vars[str_detect(vars, x)]
# })
df <- df[, c("country", "year", "period", "life_exp_wpp_avg", "imr_wpp_avg", "mys_ratio_hdr_avg", "asfr_adol_wpp_avg")]
df$period <- as.integer(str_sub(df$period, 7, 10))
df <- df[df$period == df$year & df$period != 2020, names(df) != "year"]
cor(df[, c("life_exp_wpp_avg", "imr_wpp_avg", "asfr_adol_wpp_avg", "mys_ratio_hdr_avg")], use = "pairwise.complete.obs")
df <- df %>% arrange(country, period) %>% group_by(country) %>% mutate(lag_imr_wpp_avg = lag(imr_wpp_avg), lag_asfr_adol_wpp_avg = lag(asfr_adol_wpp_avg))
missing_countries <- c("Andorra", "Czechoslovakia", "Dominica", "East Germany", "Ethiopia", "Kosovo", "Liechtenstein", "Marshall Islands", "Monaco", "Nauru", "North Vietnam", "North Yemen", "Palau", "San Marino", "Saint Kitts & Nevis", "Serbia & Montenegro", "South Vietnam", "South Yemen", "Soviet Union", "Tuvalu", "West Germany", "Yugoslavia SFR")
df <- df[, c("country", "period", "imr_wpp_avg", "lag_imr_wpp_avg", "asfr_adol_wpp_avg", "lag_asfr_adol_wpp_avg")]
df <- df[df$period != 1965 & !(df$country %in% missing_countries), ]
df <- df[!is.na(df$lag_imr_wpp_avg) & !is.na(df$lag_asfr_adol_wpp_avg), ]
df <- df %>% arrange(country, period)
# summary(df)
mean_x <- mean(df$asfr_adol_wpp_avg)
mean_y <- mean(df$imr_wpp_avg)
quant_x <- quantile(df$asfr_adol_wpp_avg)
quant_y <- quantile(df$imr_wpp_avg)
lapply(unique(df$country), function(ctry) {
  ggplot(data = df[df$country == ctry, ], 
         mapping = aes(x = lag_asfr_adol_wpp_avg, y = lag_imr_wpp_avg, xend = asfr_adol_wpp_avg, yend = imr_wpp_avg) )+ 
    geom_vline(xintercept = quant_x, color = "gray") + 
    geom_hline(yintercept = quant_y, color = "gray") + 
    geom_segment(lineend = "round") + 
    geom_point(aes(x = lag_asfr_adol_wpp_avg[period == min(period)],
                   y = lag_imr_wpp_avg[period == min(period)]), 
               shape = 22, size = 2, fill = "red") + 
    geom_point(aes(x = asfr_adol_wpp_avg[period == max(period)],
                   y = imr_wpp_avg[period == max(period)]), 
               shape = 23, size = 2, fill = "green") + 
    xlim(quant_x[1], quant_x[5]) + ylim(quant_y[1], quant_y[5]) + labs(x = "AFR (-)", y = "IMR (-)") + theme_classic() + ggtitle(ctry)
})
```
